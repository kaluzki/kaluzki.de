version: '3.7'

services:

  traefik-data:
    image: busybox
    container_name: traefik-data
    network_mode: "none"
    restart: "no"
    volumes:
      - traefik:/data
    command: sh -c "chmod -Rv 600 /data/*"

  traefik:
    image: traefik:2.10
    hostname: traefik
    container_name: traefik
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    networks:
      - apps
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - traefik:/data
      - ${TRAEFIK_CONFIG:-/dev/null}:/config:ro
    depends_on:
      - traefik-data
    ports:
      - "80:80"
      - "443:443"
    command:
#      - "--log.level=debug"
#      - "--api.debug=true"
      - "--api=true"
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      - "--entrypoints.80.address=:80"
      # https://doc.traefik.io/traefik/middlewares/http/redirectscheme/
      - "--entrypoints.80.http.redirections.entrypoint.to=:443"
      - "--entrypoints.80.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.80.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.443.address=:443"
      - "--certificatesresolvers.certs.acme.storage=/data/acme.json"
      - "--certificatesresolvers.certs.acme.httpchallenge.entrypoint=80"
    labels:
      traefik.enable: true
      traefik.http.routers.443-traefik.middlewares: auth
      traefik.http.routers.443-traefik.service: api@internal
      traefik.http.routers.443-traefik.entrypoints: 443
      traefik.http.routers.443-traefik.tls: true
      traefik.http.routers.443-traefik.tls.certresolver: certs
      traefik.http.routers.443-traefik.rule: Host(`${TRAEFIK_DOMAIN:-traefik.${APPS_DOMAIN:-app.localhost}}`)
      # https://doc.traefik.io/traefik/middlewares/http/basicauth/
      # sudo apt install -y apache2-utils
      # htpasswd -nB admin
      # escape '$' with '$$' in docker-compose.yml
      traefik.http.middlewares.auth.basicauth.users: ${TRAEFIK_AUTH:-${APPS_AUTH-admin:$$2y$$05$$dyoejH44m0Lrpvg1bVaF4.ZGlGMOzTyMGZjU6qkal1TGSyUN4FwRS}}

  # docker compose --profile mysql up -d
  mysql:
    image: mysql:5
    hostname: mysql
    container_name: mysql
    restart: unless-stopped
    networks:
      - apps
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - mysql:/var/lib/mysql
    environment:
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-root}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-${MYSQL_PASSWORD:-root}}
    profiles:
      - mysql

  pma:
    image: phpmyadmin:5.2
    hostname: pma
    container_name: pma
    restart: unless-stopped
    networks:
      - apps
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-root}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-${MYSQL_PASSWORD:-root}}
      PMA_HOST: mysql
      PMA_ARBITRARY: ${PMA_ARBITRARY:-0}
    labels:
      traefik.enable: true
      traefik.http.routers.443-pma.entrypoints: 443
      traefik.http.routers.443-pma.tls: true
      traefik.http.routers.443-pma.tls.certresolver: certs
      traefik.http.routers.443-pma.rule: Host(`${PMA_DOMAIN:-pma.${APPS_DOMAIN:-app.localhost}}`)
    profiles:
      - mysql

volumes:
  traefik:
  mysql:

networks:
  apps:
    name: ${APPS_NETWORK:-apps}
